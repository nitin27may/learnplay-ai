name: CI

on:
  push:
    branches: main
  pull_request:
    branches: main

jobs:
  build:
    name: Build & Test (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest]
        node: [20]
        python: [3.12]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node }}
          cache: 'npm'

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python }}

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true

      - name: Configure uv to use matrix Python version
        run: echo "UV_PYTHON=python${{ matrix.python }}" >> $GITHUB_ENV
        shell: bash

      - name: Install Node.js dependencies
        run: npm ci

      - name: Install Python dependencies
        run: |
          cd agent
          uv sync

      - name: Lint Python (ruff)
        run: |
          cd agent
          uv run ruff check .

      - name: Verify Python agent imports
        run: |
          cd agent
          uv run python -c "from main import graph; print('Agent loaded successfully')"

      - name: Lint TypeScript
        run: npm run lint

      - name: Type check
        run: npm run typecheck

      - name: Build frontend
        run: npm run build

      - name: Test frontend startup (Linux)
        if: runner.os == 'Linux'
        run: |
          npm start &
          FRONTEND_PID=$!
          
          timeout=30
          elapsed=0
          started=false

          while [ $elapsed -lt $timeout ] && [ "$started" = false ]; do
            if curl -s http://localhost:3000 > /dev/null 2>&1; then
              started=true
              echo "Frontend started successfully"
            else
              sleep 1
              elapsed=$((elapsed + 1))
            fi
          done

          kill $FRONTEND_PID 2>/dev/null || true

          if [ "$started" = false ]; then
            echo "Frontend failed to start within 30 seconds"
            exit 1
          fi
        shell: bash

      - name: Test frontend startup (Windows)
        if: runner.os == 'Windows'
        run: |
          npm start &
          
          $timeout = 30
          $elapsed = 0
          $started = $false

          while ($elapsed -lt $timeout -and -not $started) {
            try {
              $response = Invoke-WebRequest -Uri "http://localhost:3000" -TimeoutSec 1 -ErrorAction SilentlyContinue
              if ($response.StatusCode -eq 200) {
                $started = $true
                Write-Host "Frontend started successfully"
              }
            } catch {
              Start-Sleep -Seconds 1
              $elapsed++
            }
          }

          if (-not $started) {
            Write-Host "Frontend failed to start within 30 seconds"
            exit 1
          }
        shell: pwsh
