name: CI

on:
  push:
    branches: main
  pull_request:
    branches: main

jobs:
  build:
    name: Build & Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true

      - name: Install Node.js dependencies
        run: npm install

      - name: Install Python dependencies
        run: |
          cd agent
          uv sync

      - name: Lint Python (ruff)
        run: |
          cd agent
          uv run ruff check .

      - name: Verify Python agent imports
        run: |
          cd agent
          uv run python -c "from main import graph; print('Agent loaded successfully')"

      - name: Lint TypeScript
        run: npm run lint

      - name: Type check
        run: npm run typecheck

      - name: Build frontend
        run: npm run build

      - name: Test agent startup
        run: |
          cd agent
          uv run langgraph dev --port 8123 &
          AGENT_PID=$!
          
          timeout=30
          elapsed=0
          started=false

          while [ $elapsed -lt $timeout ] && [ "$started" = false ]; do
            if curl -s http://localhost:8123/health > /dev/null 2>&1 || curl -s http://localhost:8123/ok > /dev/null 2>&1 || curl -s http://localhost:8123 > /dev/null 2>&1; then
              started=true
              echo "Agent started successfully"
            else
              sleep 1
              elapsed=$((elapsed + 1))
            fi
          done

          kill $AGENT_PID 2>/dev/null || true

          if [ "$started" = false ]; then
            echo "Agent failed to start within 30 seconds"
            exit 1
          fi

      - name: Test frontend startup
        run: |
          npm start &
          FRONTEND_PID=$!
          
          timeout=30
          elapsed=0
          started=false

          while [ $elapsed -lt $timeout ] && [ "$started" = false ]; do
            if curl -s http://localhost:3000 > /dev/null 2>&1; then
              started=true
              echo "Frontend started successfully"
            else
              sleep 1
              elapsed=$((elapsed + 1))
            fi
          done

          kill $FRONTEND_PID 2>/dev/null || true

          if [ "$started" = false ]; then
            echo "Frontend failed to start within 30 seconds"
            exit 1
          fi
